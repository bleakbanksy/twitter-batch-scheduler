// ==UserScript==
// @name         ğŸ—“ Twitter / X â€” Schedule to Official Queue
// @namespace    https://github.com/bleakbanksy/twitter-batch-scheduler
// @version      3.0.0
// @description  Fill in tweet text, image and date, then auto-submit into Twitter's official scheduled posts queue.
// @author       Bleak Banksy
// @match        https://twitter.com/*
// @match        https://x.com/*
// @grant        none
// @run-at       document-idle
// ==/UserScript==

(function () {
  'use strict';

  const sleep = ms => new Promise(r => setTimeout(r, ms));

  // â”€â”€â”€ base64 â†’ File (no fetch needed) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function base64ToFile(dataUrl) {
    const [meta, b64] = dataUrl.split(',');
    const mime = meta.match(/:(.*?);/)[1];
    const bin  = atob(b64);
    const arr  = new Uint8Array(bin.length);
    for (let i = 0; i < bin.length; i++) arr[i] = bin.charCodeAt(i);
    const ext  = mime.split('/')[1] || 'jpg';
    return new File([arr], `image.${ext}`, { type: mime });
  }

  function fileToBase64(file) {
    return new Promise((res, rej) => {
      const r = new FileReader();
      r.onload = () => res(r.result);
      r.onerror = rej;
      r.readAsDataURL(file);
    });
  }

  // â”€â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const activeToasts = [];
  
  function showToast(msg, isError = false) {
    const t = document.createElement('div');
    t.textContent = msg;
    Object.assign(t.style, {
      position: 'fixed', top: '90px', right: '24px',
      background: isError ? '#c0392b' : '#1d9bf0',
      color: '#fff', padding: '12px 18px', borderRadius: '12px',
      fontSize: '14px', zIndex: 999999,
      boxShadow: '0 4px 20px rgba(0,0,0,0.45)',
      opacity: '0', transition: 'opacity 0.4s, top 0.3s ease',
      maxWidth: '320px', lineHeight: '1.5', fontFamily: 'sans-serif',
    });
    document.body.appendChild(t);
    
    // Push existing toasts down
    const toastHeight = t.offsetHeight + 12; // height + gap
    activeToasts.forEach(toast => {
      const currentTop = parseInt(toast.style.top);
      toast.style.top = (currentTop + toastHeight) + 'px';
    });
    
    // Add to active toasts
    activeToasts.unshift(t);
    
    // Fade in
    requestAnimationFrame(() => {
      t.style.opacity = '1';
    });
    
    // Remove after 5 seconds
    setTimeout(() => {
      t.style.opacity = '0';
      setTimeout(() => {
        const index = activeToasts.indexOf(t);
        if (index > -1) {
          activeToasts.splice(index, 1);
          
          // Shift remaining toasts up
          activeToasts.forEach((toast, i) => {
            toast.style.top = (90 + i * toastHeight) + 'px';
          });
        }
        t.remove();
      }, 400);
    }, 5000);
  }

  // â”€â”€â”€ Wait for element â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function waitFor(selector, timeout = 10000) {
    return new Promise((res, rej) => {
      const el = document.querySelector(selector);
      if (el) return res(el);
      const obs = new MutationObserver(() => {
        const found = document.querySelector(selector);
        if (found) { obs.disconnect(); res(found); }
      });
      obs.observe(document.body, { childList: true, subtree: true });
      setTimeout(() => { obs.disconnect(); rej(new Error(`Timeout: ${selector}`)); }, timeout);
    });
  }

  // â”€â”€â”€ Type into contenteditable â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function typeText(el, text) {
    console.log('[TwitterScheduler] Starting text entry...');
    
    // Click the element to simulate user interaction
    el.click();
    el.focus();
    await sleep(300);
    
    // Clear existing content
    el.innerHTML = '';
    await sleep(100);
    
    // Create proper Twitter structure
    const span = document.createElement('span');
    span.setAttribute('data-text', 'true');
    el.appendChild(span);
    
    // Type character by character with realistic timing and events
    console.log('[TwitterScheduler] Typing character by character...');
    for (let i = 0; i < text.length; i++) {
      const char = text[i];
      
      // Add character to span
      span.textContent += char;
      
      // Create realistic keyboard events for this character
      const keydownEvent = new KeyboardEvent('keydown', {
        key: char,
        code: `Key${char.toUpperCase()}`,
        keyCode: char.charCodeAt(0),
        which: char.charCodeAt(0),
        bubbles: true,
        cancelable: true,
        composed: true
      });
      
      const keypressEvent = new KeyboardEvent('keypress', {
        key: char,
        code: `Key${char.toUpperCase()}`,
        keyCode: char.charCodeAt(0),
        which: char.charCodeAt(0),
        bubbles: true,
        cancelable: true,
        composed: true
      });
      
      const inputEvent = new InputEvent('input', {
        data: char,
        inputType: 'insertText',
        bubbles: true,
        cancelable: false,
        composed: true
      });
      
      const keyupEvent = new KeyboardEvent('keyup', {
        key: char,
        code: `Key${char.toUpperCase()}`,
        keyCode: char.charCodeAt(0),
        which: char.charCodeAt(0),
        bubbles: true,
        cancelable: true,
        composed: true
      });
      
      // Dispatch events in proper order
      el.dispatchEvent(keydownEvent);
      el.dispatchEvent(keypressEvent);
      el.dispatchEvent(inputEvent);
      el.dispatchEvent(keyupEvent);
      
      // Small delay every few characters to seem natural
      if (i % 5 === 0) {
        await sleep(20);
      }
    }
    
    // Final events to ensure React picks up the change
    el.dispatchEvent(new InputEvent('input', { 
      bubbles: true, 
      cancelable: false,
      inputType: 'insertText',
      data: text
    }));
    
    el.dispatchEvent(new Event('change', { bubbles: true }));
    
    // Try to trigger React's state update by finding and calling its internal handler
    const reactKey = Object.keys(el).find(key => key.startsWith('__react'));
    if (reactKey) {
      console.log('[TwitterScheduler] Found React internal key:', reactKey);
      try {
        const reactProps = el[reactKey];
        if (reactProps?.memoizedProps?.onChange) {
          reactProps.memoizedProps.onChange({ target: el, currentTarget: el });
        }
        if (reactProps?.return?.memoizedProps?.onChange) {
          reactProps.return.memoizedProps.onChange({ target: el, currentTarget: el });
        }
      } catch (e) {
        console.warn('[TwitterScheduler] Could not trigger React onChange:', e);
      }
    }
    
    await sleep(500);
    
    const finalText = el.textContent || '';
    console.log('[TwitterScheduler] Final text:', finalText);
    console.log('[TwitterScheduler] Final HTML:', el.innerHTML);
    console.log('[TwitterScheduler] Text length:', finalText.length);
    
    // Verify the Post/Schedule button is enabled
    const tweetButton = document.querySelector('[data-testid="tweetButton"]') ||
                       document.querySelector('[data-testid="tweetButtonInline"]');
    if (tweetButton) {
      const isDisabled = tweetButton.hasAttribute('disabled') || tweetButton.getAttribute('aria-disabled') === 'true';
      console.log('[TwitterScheduler] Tweet button disabled?', isDisabled);
      
      if (isDisabled) {
        console.warn('[TwitterScheduler] Button still disabled! Trying fallback...');
        // One more attempt with click + paste simulation
        el.focus();
        await sleep(200);
        
        const pasteEvent = new ClipboardEvent('paste', {
          bubbles: true,
          cancelable: true,
          clipboardData: new DataTransfer()
        });
        
        // Try to set clipboard data
        try {
          Object.defineProperty(pasteEvent, 'clipboardData', {
            value: {
              getData: () => text,
              types: ['text/plain'],
              items: []
            }
          });
          el.dispatchEvent(pasteEvent);
        } catch (e) {
          console.warn('[TwitterScheduler] Paste event failed:', e);
        }
        
        await sleep(300);
      }
    }
  }

  // â”€â”€â”€ Wait for DOM to stabilize (no mutations for a period) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function waitForDOMStable(timeout = 1500, stableFor = 300) {
    return new Promise((resolve) => {
      let timer;
      let stableTimer;
      
      const observer = new MutationObserver(() => {
        // Reset stability timer on any mutation
        clearTimeout(stableTimer);
        stableTimer = setTimeout(() => {
          observer.disconnect();
          clearTimeout(timer);
          resolve();
        }, stableFor);
      });
      
      observer.observe(document.body, {
        childList: true,
        subtree: true,
        attributes: true
      });
      
      // Start stability timer immediately
      stableTimer = setTimeout(() => {
        observer.disconnect();
        clearTimeout(timer);
        resolve();
      }, stableFor);
      
      // Overall timeout
      timer = setTimeout(() => {
        observer.disconnect();
        clearTimeout(stableTimer);
        resolve();
      }, timeout);
    });
  }

  // â”€â”€â”€ Set a React-controlled <select> robustly â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // The key insight: React tracks the value via its own internal fiber.
  // We must use the native HTMLSelectElement setter (not the React-wrapped one)
  // AND dispatch a real 'change' event so React's synthetic handler fires.
  async function setReactSelect(selectEl, value) {
    // Get the original (pre-React) setter from the prototype
    const nativeSetter = Object.getOwnPropertyDescriptor(
      HTMLSelectElement.prototype, 'value'
    ).set;

    // Focus the element first (React sometimes ignores unfocused changes)
    selectEl.focus();
    await sleep(100);

    // Set value via native setter â€” bypasses React's overridden setter
    nativeSetter.call(selectEl, String(value));

    // Fire the events React listens to in the correct order
    selectEl.dispatchEvent(new Event('input',  { bubbles: true }));
    selectEl.dispatchEvent(new Event('change', { bubbles: true }));
    selectEl.dispatchEvent(new Event('blur',   { bubbles: true }));

    // Small pause so React starts re-rendering
    await sleep(150);
  }

  // â”€â”€â”€ Main automation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let isBusy = false;

  async function runSchedule({ text, imageBase64, scheduledAt }) {
    if (isBusy) { showToast('Still working on a post, please waitâ€¦', true); return; }
    isBusy = true;

    try {
      // 1 â”€â”€ Open the compose box
      const composeBtn =
        document.querySelector('a[data-testid="SideNav_NewTweet_Button"]') ||
        document.querySelector('[data-testid="SideNav_NewTweet_Button"]')  ||
        document.querySelector('a[href="/compose/tweet"]');

      if (!composeBtn) throw new Error('Post button not found â€” make sure you are on twitter.com/home.');
      composeBtn.click();
      showToast('ğŸ“ Opening compose boxâ€¦');
      await sleep(2000);

      // 2 â”€â”€ Enter tweet text
      const editor = await waitFor(
        '[data-testid="tweetTextarea_0"] [contenteditable="true"], [data-testid="tweetTextarea_0"]'
      );
      await typeText(editor, text);
      showToast('âœï¸ Text enteredâ€¦');
      
      // CRITICAL: Wait longer for Twitter to process the text
      await sleep(1000);
      
      // Verify text is still there
      const verifyText = editor.textContent || editor.innerText || '';
      if (verifyText.trim() !== text.trim()) {
        console.warn('[TwitterScheduler] Text verification failed after wait, re-entering...');
        await typeText(editor, text);
        await sleep(800);
      }
      
      console.log('[TwitterScheduler] Text confirmed in editor');

      // 3 â”€â”€ Attach image
      if (imageBase64) {
        showToast('ğŸ–¼ Attaching imageâ€¦');
        const file      = base64ToFile(imageBase64);
        const fileInput = await waitFor(
          'input[data-testid="fileInput"], input[type="file"][accept*="image"]'
        );
        
        // Simple FileList-like object to avoid "Illegal invocation" completely
        // Don't use DataTransfer at all - just create a plain object
        const fileList = {
          0: file,
          length: 1,
          item: function(index) { return index === 0 ? file : null; }
        };
        
        // Add iterator support
        fileList[Symbol.iterator] = function* () {
          yield file;
        };
        
        // Set the files property
        try {
          Object.defineProperty(fileInput, 'files', {
            value: fileList,
            writable: false,
            configurable: true
          });
        } catch (e) {
          console.warn('[TwitterScheduler] Setting files property failed:', e);
          // Last resort: try to set it directly
          try {
            fileInput.files = fileList;
          } catch (e2) {
            console.error('[TwitterScheduler] All file attachment methods failed:', e2);
            throw new Error('Unable to attach image file');
          }
        }
        
        // Trigger events
        const changeEvent = new Event('change', { bubbles: true });
        const inputEvent = new Event('input', { bubbles: true });
        fileInput.dispatchEvent(changeEvent);
        fileInput.dispatchEvent(inputEvent);
        
        try {
          await waitFor('[data-testid="attachments"] img, [data-testid="tweetPhoto"]', 12000);
          showToast('ğŸ–¼ Image attached!');
        } catch {
          showToast('âš ï¸ Image preview not detected â€” continuing anyway.', true);
        }
        await sleep(600);
      }

      // 4 â”€â”€ Open the schedule picker (clock icon in composer toolbar)
      showToast('ğŸ• Opening schedule pickerâ€¦');
      
      // Final text verification before scheduling
      const finalEditor = document.querySelector('[data-testid="tweetTextarea_0"] [contenteditable="true"]') ||
                         document.querySelector('[data-testid="tweetTextarea_0"]');
      if (finalEditor) {
        const finalText = finalEditor.textContent || finalEditor.innerText || '';
        console.log(`[TwitterScheduler] Final text check: "${finalText}"`);
        if (finalText.trim() !== text.trim()) {
          console.warn('[TwitterScheduler] Text disappeared! Re-entering before schedule...');
          await typeText(finalEditor, text);
          await sleep(1000);
        }
      }
      
      const schedBtn =
        document.querySelector('[data-testid="scheduleOption"]') ||
        document.querySelector('[aria-label*="chedule"]');

      if (!schedBtn) throw new Error('Schedule (clock) button not found in the composer toolbar.');
      schedBtn.click();
      await sleep(2000); // give the picker time to fully render

      // 5 â”€â”€ Find the <select> dropdowns inside the schedule picker
      // Twitter's order: Month (0-indexed) | Day | Year | Hour | Minute | AM/PM
      const pickerSelects = [
        ...document.querySelectorAll('[data-testid="schedulePicker"] select'),
        ...document.querySelectorAll('[role="dialog"] select'),
      ];
      // De-duplicate (same element might match both selectors)
      const selects = [...new Set(pickerSelects)];

      console.log('[TwitterScheduler] Found', selects.length, 'schedule selects');
      if (selects.length < 5) {
        throw new Error(
          `Only found ${selects.length} date/time dropdowns (expected 5+). ` +
          `Twitter's schedule picker may not have opened. Try clicking the clock icon manually.`
        );
      }

      showToast('ğŸ“… Setting date & timeâ€¦');
      const d    = new Date(scheduledAt);
      const day  = d.getDate();
      const year = d.getFullYear();
      let   hour = d.getHours();
      const min  = d.getMinutes();
      const ampm = hour >= 12 ? 'PM' : 'AM';
      hour       = hour % 12 || 12;

      // Helper: re-query selects fresh each time (Twitter re-renders after each change)
      const getSelects = () => {
        const all = [
          ...document.querySelectorAll('[data-testid="schedulePicker"] select'),
          ...document.querySelectorAll('[role="dialog"] select'),
        ];
        return [...new Set(all)];
      };

      // Helper: set a select and verify it actually changed, with retry
      async function setAndVerify(index, value, label) {
        for (let attempt = 0; attempt < 5; attempt++) {  // Increased from 3 to 5 attempts
          const freshSelects = getSelects();
          if (!freshSelects[index]) { console.warn(`[TwitterScheduler] select[${index}] missing`); return; }
          const sel = freshSelects[index];

          // Log what options are available on first attempt
          if (attempt === 0) {
            const opts = [...sel.options].map(o => `${o.value}="${o.text}"`).join(', ');
            console.log(`[TwitterScheduler] select[${index}] (${label}) options:`, opts);
          }

          // Find the matching option - try value first, then text content
          const targetValue = String(value);
          let matchedOption = [...sel.options].find(opt => 
            opt.value === targetValue || 
            opt.text.trim() === targetValue ||
            opt.textContent.trim() === targetValue
          );
          
          if (!matchedOption) {
            console.warn(`[TwitterScheduler] No matching option for "${targetValue}" in ${label}`);
            return;
          }

          await setReactSelect(sel, matchedOption.value);
          
          // CRITICAL: Wait for DOM to stabilize after React re-renders
          await waitForDOMStable(1500, 500);  // Increased wait times

          // Verify it stuck - check multiple times
          let verified = false;
          for (let verifyAttempt = 0; verifyAttempt < 3; verifyAttempt++) {
            await sleep(200);
            const nowSelects = getSelects();
            const nowSel = nowSelects[index];
            if (nowSel && nowSel.value === matchedOption.value) {
              verified = true;
              break;
            }
            if (verifyAttempt < 2) {
              console.warn(`[TwitterScheduler] Verification attempt ${verifyAttempt + 1}: value changed, re-checking...`);
            }
          }

          if (verified) {
            console.log(`[TwitterScheduler] âœ“ select[${index}] (${label}) = ${value} (option value: ${matchedOption.value})`);
            return;
          }
          
          const nowSelects = getSelects();
          const nowSel = nowSelects[index];
          console.warn(`[TwitterScheduler] âœ— select[${index}] (${label}) expected ${matchedOption.value}, got ${nowSel?.value} â€” retrying (attempt ${attempt + 1}/5)`);
          await sleep(800);  // Longer wait before retry
        }
        
        console.error(`[TwitterScheduler] Failed to set ${label} after 5 attempts`);
      }

      // Twitter uses month NAMES not numbers, so match by name
      const monthNames = [
        'January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'
      ];
      const targetMonth = d.getMonth(); // 0-11
      const targetMonthName = monthNames[targetMonth];
      
      // Check what format Twitter actually uses by examining the month select
      const monthSelects = getSelects();
      const monthSelect = monthSelects[0];
      
      console.log(`[TwitterScheduler] Target month: ${targetMonthName} (index: ${targetMonth})`);
      console.log(`[TwitterScheduler] Month select options:`);
      [...monthSelect.options].forEach((opt, i) => {
        console.log(`  [${i}] value="${opt.value}" text="${opt.text}"`);
      });
      
      // Find the correct month option by matching the text
      const monthOption = [...monthSelect.options].find(opt => {
        const optText = opt.text.trim();
        // Try exact match, partial match, or by index matching
        return optText === targetMonthName || 
               optText.startsWith(targetMonthName.substring(0, 3)) ||
               optText.toLowerCase().includes(targetMonthName.toLowerCase());
      });
      
      let monthValue;
      if (monthOption) {
        // Use the option's value (whatever format Twitter uses)
        monthValue = monthOption.value;
        console.log(`[TwitterScheduler] Matched month option: value="${monthValue}" text="${monthOption.text}"`);
      } else {
        // Fallback: try numeric formats
        const firstOption = monthSelect.options[0];
        if (firstOption && !isNaN(Number(firstOption.value))) {
          // Numeric values - detect if 0-indexed or 1-indexed
          const monthOpts = [...monthSelect.options].map(o => Number(o.value));
          const monthMin = Math.min(...monthOpts);
          monthValue = monthMin === 0 ? targetMonth : targetMonth + 1;
          console.log(`[TwitterScheduler] Using numeric month: ${monthValue} (0-indexed: ${monthMin === 0})`);
        } else {
          // Last resort: use month name
          monthValue = targetMonthName;
          console.log(`[TwitterScheduler] Fallback to month name: ${monthValue}`);
        }
      }

      // Set each field in the optimal order to avoid creating past dates
      // CRITICAL: Set Year FIRST to avoid temporary past dates
      // Example: If today is Feb 22, 2026 and we set Month=January first,
      // Twitter would interpret it as Jan 22, 2026 (past), causing an error.
      
      console.log(`[TwitterScheduler] Target date: ${d.toLocaleString()}`);
      console.log(`[TwitterScheduler] Setting: Year=${year}, Month=${monthValue}, Day=${day}, Hour=${hour}, Min=${min}, ${ampm}`);
      
      await setAndVerify(2, year,                         'Year');    // Set year FIRST
      await setAndVerify(0, monthValue,                   'Month');   // Then month
      await setAndVerify(1, day,                          'Day');     // Then day
      await setAndVerify(3, hour,                         'Hour');    // Then hour
      await setAndVerify(4, String(min).padStart(2, '0'), 'Minute'); // Then minute

      const freshForAmPm = getSelects();
      if (freshForAmPm[5]) await setAndVerify(5, ampm,    'AM/PM');  // Finally AM/PM

      // Final stability wait before confirming
      await waitForDOMStable(1000, 400);
      
      // FINAL VERIFICATION: Check all fields stayed correct
      console.log('[TwitterScheduler] Final verification of all fields...');
      const finalSelects = getSelects();
      
      // Re-check month specifically (the problematic field)
      const finalMonthSelect = finalSelects[0];
      const currentMonthText = finalMonthSelect.options[finalMonthSelect.selectedIndex]?.text;
      
      console.log(`[TwitterScheduler] Current month selection: value="${finalMonthSelect.value}" text="${currentMonthText}"`);
      console.log(`[TwitterScheduler] Expected month: "${targetMonthName}"`);
      
      // Check if month text matches what we want
      const monthIsCorrect = currentMonthText && (
        currentMonthText.trim() === targetMonthName ||
        currentMonthText.trim().startsWith(targetMonthName.substring(0, 3)) ||
        currentMonthText.toLowerCase().includes(targetMonthName.toLowerCase())
      );
      
      if (!monthIsCorrect) {
        console.warn(`[TwitterScheduler] Month value drifted! Current: "${currentMonthText}", Expected: "${targetMonthName}". Re-setting...`);
        // Re-find the correct option
        const correctMonthOption = [...finalMonthSelect.options].find(opt => {
          const optText = opt.text.trim();
          return optText === targetMonthName || 
                 optText.startsWith(targetMonthName.substring(0, 3)) ||
                 optText.toLowerCase().includes(targetMonthName.toLowerCase());
        });
        if (correctMonthOption) {
          await setAndVerify(0, correctMonthOption.value, 'Month (final fix)');
          await waitForDOMStable(1000, 400);
        }
      }
      
      console.log('[TwitterScheduler] Final values:');
      console.log(`  Month: ${finalSelects[0]?.value} (${finalSelects[0]?.options[finalSelects[0]?.selectedIndex]?.text})`);
      console.log(`  Day: ${finalSelects[1]?.value}`);
      console.log(`  Year: ${finalSelects[2]?.value}`);
      console.log(`  Hour: ${finalSelects[3]?.value}`);
      console.log(`  Minute: ${finalSelects[4]?.value}`);
      if (finalSelects[5]) console.log(`  AM/PM: ${finalSelects[5]?.value}`);

      // 6 â”€â”€ Click Confirm
      let confirmBtn = null;
      for (const btn of document.querySelectorAll('button')) {
        if (/confirm/i.test(btn.textContent.trim())) { confirmBtn = btn; break; }
      }
      if (!confirmBtn) throw new Error('Confirm button not found inside the schedule picker.');
      confirmBtn.click();
      showToast('âœ… Date confirmed!');
      await sleep(1200);

      // 7 â”€â”€ Click the final Schedule button (replaces the normal Post button)
      showToast('ğŸš€ Scheduling tweetâ€¦');
      let finalBtn = null;
      for (const btn of document.querySelectorAll('button')) {
        if (/^schedule$/i.test(btn.textContent.trim())) { finalBtn = btn; break; }
      }
      if (!finalBtn) finalBtn = document.querySelector('[data-testid="tweetButton"]');
      if (!finalBtn) throw new Error('Final Schedule button not found.');
      finalBtn.click();
      await sleep(1500);

      showToast('ğŸ‰ Tweet added to your official Twitter scheduled queue!');
    } catch (err) {
      console.error('[TwitterScheduler]', err);
      showToast(`âŒ ${err.message}`, true);
    } finally {
      isBusy = false;
    }
  }

  // â”€â”€â”€ Panel UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let panel = null;
  let panelOpen = false;
  let queuedTweets = [];

  function buildPanel() {
    // Full screen overlay
    const overlay = document.createElement('div');
    overlay.id = 'twx-overlay';
    Object.assign(overlay.style, {
      position: 'fixed', top: '0', left: '0', width: '100%', height: '100%',
      background: 'rgba(0, 0, 0, 0.7)', zIndex: 999997,
      display: 'none', backdropFilter: 'blur(4px)'
    });
    document.body.appendChild(overlay);

    panel = document.createElement('div');
    Object.assign(panel.style, {
      position: 'fixed', top: '50%', left: '50%', transform: 'translate(-50%, -50%)',
      width: '95%', maxWidth: '1200px', height: '90vh', maxHeight: '900px',
      background: '#000', border: '1px solid #2f3336', borderRadius: '20px',
      zIndex: 999998, display: 'flex', flexDirection: 'column',
      boxShadow: '0 20px 60px rgba(0,0,0,0.9)',
      fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif',
      overflow: 'hidden',
    });

    panel.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:space-between;padding:20px 24px;border-bottom:1px solid #2f3336;background:#0a0a0a">
        <div style="display:flex;align-items:center;gap:12px">
          <span style="font-size:26px">ğŸ—“</span>
          <div>
            <div style="color:#e7e9ea;font-weight:700;font-size:18px">Batch Tweet Scheduler</div>
            <div style="color:#71767b;font-size:12px;margin-top:2px">Queue multiple tweets and schedule them all at once</div>
          </div>
        </div>
        <button id="twx-close" style="background:none;border:none;color:#555;font-size:24px;cursor:pointer;padding:8px">âœ•</button>
      </div>
      
      <div style="display:flex;flex:1;overflow:hidden">
        <!-- Left side: Input form -->
        <div style="width:45%;padding:24px;display:flex;flex-direction:column;gap:16px;border-right:1px solid #2f3336;overflow-y:auto">
          <div style="color:#e7e9ea;font-weight:700;font-size:16px;margin-bottom:4px">â• Add New Tweet</div>

          <div>
            <label style="color:#71767b;font-size:11px;font-weight:700;letter-spacing:.8px;display:block;margin-bottom:6px">TWEET TEXT</label>
            <textarea id="twx-text" maxlength="280" placeholder="What's happening?"
              style="width:100%;box-sizing:border-box;background:#16181c;border:1px solid #2f3336;
                     border-radius:12px;color:#e7e9ea;font-size:15px;padding:12px 14px;
                     resize:vertical;min-height:140px;outline:none;font-family:inherit;line-height:1.5"></textarea>
            <div id="twx-chars" style="text-align:right;font-size:12px;color:#555;margin-top:4px">0 / 280</div>
          </div>

          <div>
            <label style="color:#71767b;font-size:11px;font-weight:700;letter-spacing:.8px;display:block;margin-bottom:6px">SCHEDULED DATE & TIME</label>
            <input type="datetime-local" id="twx-date"
              style="width:100%;box-sizing:border-box;background:#16181c;border:1px solid #2f3336;
                     border-radius:12px;color:#e7e9ea;font-size:14px;padding:12px 14px;outline:none">
          </div>

          <div>
            <label style="color:#71767b;font-size:11px;font-weight:700;letter-spacing:.8px;display:block;margin-bottom:6px">IMAGE (OPTIONAL)</label>
            <label style="display:flex;align-items:center;gap:12px;background:#16181c;border:1px dashed #2f3336;
                   border-radius:12px;padding:12px 14px;cursor:pointer;transition:border-color 0.2s"
                   onmouseover="this.style.borderColor='#555'"
                   onmouseout="this.style.borderColor='#2f3336'">
              <span style="font-size:20px">ğŸ–¼</span>
              <span id="twx-img-lbl" style="color:#71767b;font-size:14px">Click to attach imageâ€¦</span>
              <input type="file" id="twx-img" accept="image/*" style="display:none">
            </label>
            <div id="twx-img-wrap" style="display:none;margin-top:10px;position:relative">
              <img id="twx-img-prev" style="width:100%;max-height:200px;object-fit:cover;border-radius:12px;display:block">
              <button id="twx-img-clr" style="position:absolute;top:8px;right:8px;background:rgba(0,0,0,.85);
                      border:none;color:#fff;border-radius:50%;width:28px;height:28px;cursor:pointer;font-size:14px">âœ•</button>
            </div>
          </div>

          <div id="twx-err" style="display:none;background:#c0392b22;border:1px solid #c0392b55;
               border-radius:10px;color:#ff7070;font-size:13px;padding:10px 14px;line-height:1.6"></div>

          <button id="twx-add-queue"
            style="width:100%;padding:14px;background:#1d9bf0;border:none;border-radius:24px;
                   color:#fff;font-size:15px;font-weight:700;cursor:pointer;transition:background 0.2s">
            â• Add to Queue
          </button>
        </div>

        <!-- Right side: Queue list -->
        <div style="width:55%;display:flex;flex-direction:column">
          <div style="padding:20px 24px;border-bottom:1px solid #2f3336">
            <div style="display:flex;align-items:center;justify-content:space-between">
              <div>
                <div style="color:#e7e9ea;font-weight:700;font-size:16px">ğŸ“‹ Scheduled Queue</div>
                <div style="color:#71767b;font-size:12px;margin-top:2px"><span id="twx-queue-count">0</span> tweets ready</div>
              </div>
              <button id="twx-schedule-all"
                style="padding:10px 20px;background:#16a34a;border:none;border-radius:20px;
                       color:#fff;font-size:14px;font-weight:700;cursor:pointer;transition:background 0.2s"
                disabled>
                ğŸš€ Schedule All
              </button>
            </div>
          </div>
          
          <div id="twx-queue-list" style="flex:1;overflow-y:auto;padding:16px 24px">
            <div style="text-align:center;padding:60px 20px;color:#555">
              <div style="font-size:48px;margin-bottom:12px">ğŸ“­</div>
              <div style="font-size:14px">No tweets in queue yet</div>
              <div style="font-size:12px;margin-top:6px">Add tweets on the left to get started</div>
            </div>
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(panel);

    document.getElementById('twx-close').addEventListener('click', togglePanel);
    document.getElementById('twx-overlay').addEventListener('click', togglePanel);

    const textarea = document.getElementById('twx-text');
    const chars    = document.getElementById('twx-chars');
    textarea.addEventListener('input', () => {
      const n = textarea.value.length;
      chars.textContent  = `${n} / 280`;
      chars.style.color  = n > 260 ? '#ff7070' : '#555';
    });

    let imgBase64 = null;
    const imgInput = document.getElementById('twx-img');
    const imgLbl   = document.getElementById('twx-img-lbl');
    const imgWrap  = document.getElementById('twx-img-wrap');
    const imgPrev  = document.getElementById('twx-img-prev');

    imgInput.addEventListener('change', async () => {
      const f = imgInput.files[0];
      if (!f) return;
      imgBase64 = await fileToBase64(f);
      imgLbl.textContent = 'âœ… ' + f.name;
      imgPrev.src = imgBase64;
      imgWrap.style.display = 'block';
      // Clear temp image when new one is uploaded
      const addQueueBtn = document.getElementById('twx-add-queue');
      if (addQueueBtn) addQueueBtn._tempImageBase64 = null;
    });
    
    document.getElementById('twx-img-clr').addEventListener('click', () => {
      imgBase64 = null; imgInput.value = '';
      imgLbl.textContent = 'Click to attach imageâ€¦';
      imgWrap.style.display = 'none';
      // Clear temp image when cleared
      const addQueueBtn = document.getElementById('twx-add-queue');
      if (addQueueBtn) addQueueBtn._tempImageBase64 = null;
    });

    // Add to queue button
    const addQueueBtn = document.getElementById('twx-add-queue');
    addQueueBtn.addEventListener('mouseenter', () => addQueueBtn.style.background = '#1a8cd8');
    addQueueBtn.addEventListener('mouseleave', () => addQueueBtn.style.background = '#1d9bf0');
    addQueueBtn.addEventListener('click', () => {
      const errEl = document.getElementById('twx-err');
      errEl.style.display = 'none';
      const text    = textarea.value.trim();
      const dateVal = document.getElementById('twx-date').value;
      
      if (!text) { errEl.textContent = 'Please enter tweet text.'; errEl.style.display = 'block'; return; }
      if (!dateVal) { errEl.textContent = 'Please pick a date & time.'; errEl.style.display = 'block'; return; }
      if (new Date(dateVal).getTime() <= Date.now()) { errEl.textContent = 'Date must be in the future.'; errEl.style.display = 'block'; return; }
      
      // Use temp image or current image
      const finalImage = addQueueBtn._tempImageBase64 || imgBase64;
      
      // Add to queue
      queuedTweets.push({
        id: Date.now(),
        text,
        imageBase64: finalImage,
        scheduledAt: new Date(dateVal).getTime(),
        status: 'pending'
      });
      
      // Clear form
      textarea.value = '';
      chars.textContent = '0 / 280';
      document.getElementById('twx-date').value = '';
      imgBase64 = null;
      imgInput.value = '';
      imgLbl.textContent = 'Click to attach imageâ€¦';
      imgWrap.style.display = 'none';
      addQueueBtn._tempImageBase64 = null;
      
      updateQueueDisplay();
      showToast('âœ… Added to queue!');
    });

    // Schedule all button
    const scheduleAllBtn = document.getElementById('twx-schedule-all');
    scheduleAllBtn.addEventListener('mouseenter', () => scheduleAllBtn.style.background = '#15803d');
    scheduleAllBtn.addEventListener('mouseleave', () => scheduleAllBtn.style.background = '#16a34a');
    scheduleAllBtn.addEventListener('click', async () => {
      if (queuedTweets.length === 0) return;
      
      scheduleAllBtn.disabled = true;
      scheduleAllBtn.textContent = 'â³ Scheduling...';
      
      for (let i = 0; i < queuedTweets.length; i++) {
        const tweet = queuedTweets[i];
        if (tweet.status !== 'pending') continue;
        
        try {
          tweet.status = 'processing';
          updateQueueDisplay();
          
          await runSchedule({
            text: tweet.text,
            imageBase64: tweet.imageBase64,
            scheduledAt: tweet.scheduledAt
          });
          
          tweet.status = 'completed';
          updateQueueDisplay();
          
          // Wait between tweets to avoid rate limiting
          if (i < queuedTweets.length - 1) {
            await sleep(3000);
          }
        } catch (err) {
          tweet.status = 'failed';
          tweet.error = err.message;
          updateQueueDisplay();
        }
      }
      
      scheduleAllBtn.textContent = 'ğŸš€ Schedule All';
      scheduleAllBtn.disabled = false;
      
      // Remove completed tweets after a delay
      setTimeout(() => {
        queuedTweets = queuedTweets.filter(t => t.status === 'pending');
        updateQueueDisplay();
      }, 3000);
    });
  }

  function updateQueueDisplay() {
    const queueList = document.getElementById('twx-queue-list');
    const queueCount = document.getElementById('twx-queue-count');
    const scheduleAllBtn = document.getElementById('twx-schedule-all');
    
    const pendingCount = queuedTweets.filter(t => t.status === 'pending').length;
    queueCount.textContent = pendingCount;
    scheduleAllBtn.disabled = pendingCount === 0;
    
    if (queuedTweets.length === 0) {
      queueList.innerHTML = `
        <div style="text-align:center;padding:60px 20px;color:#555">
          <div style="font-size:48px;margin-bottom:12px">ğŸ“­</div>
          <div style="font-size:14px">No tweets in queue yet</div>
          <div style="font-size:12px;margin-top:6px">Add tweets on the left to get started</div>
        </div>
      `;
      return;
    }
    
    queueList.innerHTML = queuedTweets.map((tweet, idx) => {
      const date = new Date(tweet.scheduledAt);
      const dateStr = date.toLocaleString('en-US', { 
        month: 'short', day: 'numeric', year: 'numeric',
        hour: 'numeric', minute: '2-digit', hour12: true 
      });
      
      let statusIcon = 'â³';
      let statusColor = '#71767b';
      if (tweet.status === 'processing') { statusIcon = 'ğŸ”„'; statusColor = '#1d9bf0'; }
      if (tweet.status === 'completed') { statusIcon = 'âœ…'; statusColor = '#16a34a'; }
      if (tweet.status === 'failed') { statusIcon = 'âŒ'; statusColor = '#c0392b'; }
      
      const isClickable = tweet.status === 'pending';
      
      return `
        <div class="${isClickable ? 'twx-tweet-card' : ''}" data-tweet-id="${tweet.id}"
          style="background:#16181c;border:1px solid #2f3336;border-radius:12px;padding:14px;margin-bottom:12px;position:relative;
                 ${isClickable ? 'cursor:pointer;transition:background 0.2s,border-color 0.2s;' : ''}"
          ${isClickable ? 'onmouseover="this.style.background=\'#1a1d21\';this.style.borderColor=\'#3a434d\'" onmouseout="this.style.background=\'#16181c\';this.style.borderColor=\'#2f3336\'"' : ''}>
          <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px">
            <div style="color:${statusColor};font-size:12px;font-weight:700;display:flex;align-items:center;gap:6px">
              <span>${statusIcon}</span>
              <span>${tweet.status.toUpperCase()}</span>
            </div>
            ${tweet.status === 'pending' ? `
              <button class="twx-remove-btn" data-tweet-id="${tweet.id}" 
                style="background:none;border:none;color:#555;cursor:pointer;font-size:16px;padding:4px;line-height:1;transition:color 0.2s;z-index:10;position:relative"
                onmouseover="this.style.color='#ff4444'" 
                onmouseout="this.style.color='#555'">âœ•</button>
            ` : ''}
          </div>
          <div style="color:#e7e9ea;font-size:14px;line-height:1.5;margin-bottom:8px">${tweet.text.substring(0, 150)}${tweet.text.length > 150 ? '...' : ''}</div>
          <div style="display:flex;align-items:center;gap:12px;font-size:12px;color:#71767b">
            <span>ğŸ“… ${dateStr}</span>
            ${tweet.imageBase64 ? '<span>ğŸ–¼ Image attached</span>' : ''}
          </div>
          ${tweet.error ? `<div style="color:#ff7070;font-size:11px;margin-top:6px">Error: ${tweet.error}</div>` : ''}
          ${isClickable ? '<div style="color:#71767b;font-size:11px;margin-top:8px;font-style:italic">ğŸ’¡ Click to edit</div>' : ''}
        </div>
      `;
    }).join('');
    
    // Add click handlers to all remove buttons
    document.querySelectorAll('.twx-remove-btn').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.stopPropagation(); // Prevent triggering the card click
        const tweetId = parseInt(this.getAttribute('data-tweet-id'));
        queuedTweets = queuedTweets.filter(t => t.id !== tweetId);
        updateQueueDisplay();
        showToast('ğŸ—‘ Removed from queue');
      });
    });
    
    // Add click handlers to pending tweet cards for editing
    document.querySelectorAll('.twx-tweet-card').forEach(card => {
      card.addEventListener('click', function() {
        const tweetId = parseInt(this.getAttribute('data-tweet-id'));
        const tweet = queuedTweets.find(t => t.id === tweetId);
        if (!tweet || tweet.status !== 'pending') return;
        
        // Load tweet into form
        const textarea = document.getElementById('twx-text');
        const dateInput = document.getElementById('twx-date');
        const chars = document.getElementById('twx-chars');
        const imgLbl = document.getElementById('twx-img-lbl');
        const imgWrap = document.getElementById('twx-img-wrap');
        const imgPrev = document.getElementById('twx-img-prev');
        const imgInput = document.getElementById('twx-img');
        
        // Set text
        textarea.value = tweet.text;
        chars.textContent = `${tweet.text.length} / 280`;
        chars.style.color = tweet.text.length > 260 ? '#ff7070' : '#555';
        
        // Set date/time
        const d = new Date(tweet.scheduledAt);
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        const hours = String(d.getHours()).padStart(2, '0');
        const minutes = String(d.getMinutes()).padStart(2, '0');
        dateInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
        
        // Set image if exists
        if (tweet.imageBase64) {
          imgLbl.textContent = 'âœ… Image attached';
          imgPrev.src = tweet.imageBase64;
          imgWrap.style.display = 'block';
          // Store in closure for the form
          const addQueueBtn = document.getElementById('twx-add-queue');
          addQueueBtn._tempImageBase64 = tweet.imageBase64;
        } else {
          imgLbl.textContent = 'Click to attach imageâ€¦';
          imgWrap.style.display = 'none';
          imgInput.value = '';
          const addQueueBtn = document.getElementById('twx-add-queue');
          addQueueBtn._tempImageBase64 = null;
        }
        
        // Remove from queue
        queuedTweets = queuedTweets.filter(t => t.id !== tweetId);
        updateQueueDisplay();
        showToast('âœï¸ Tweet loaded for editing');
      });
    });
  }

  function togglePanel() {
    panelOpen = !panelOpen;
    if (!panel && panelOpen) buildPanel();
    const overlay = document.getElementById('twx-overlay');
    if (panel && overlay) {
      panel.style.display = panelOpen ? 'flex' : 'none';
      overlay.style.display = panelOpen ? 'block' : 'none';
    }
  }

  // â”€â”€â”€ Floating button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function buildFAB() {
    const btn = document.createElement('button');
    btn.textContent = 'Batch Tweet Scheduler';
    btn.title = 'Schedule multiple tweets';
    Object.assign(btn.style, {
      position: 'fixed', top: '24px', right: '24px',
      padding: '12px 20px', borderRadius: '24px',
      background: '#1d9bf0', border: 'none',
      fontSize: '14px', fontWeight: '700', color: '#fff', cursor: 'pointer', zIndex: 999999,
      boxShadow: '0 4px 24px rgba(29,155,240,0.55)',
      transition: 'transform .15s, box-shadow .15s',
      display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px',
      whiteSpace: 'nowrap', fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif',
    });
    btn.addEventListener('mouseenter', () => { btn.style.transform = 'scale(1.05)'; });
    btn.addEventListener('mouseleave', () => { btn.style.transform = 'scale(1)'; });
    btn.addEventListener('click', togglePanel);
    document.body.appendChild(btn);
  }

  setTimeout(() => {
    buildFAB();
    console.log('[TwitterScheduler v3] Ready.');
  }, 1800);

})();
